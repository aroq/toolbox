#!/usr/bin/env variant
# vi: ft=yaml

description: Install the dependencies

steps:
- script: |
    rm -fR .toolbox/tools
    mkdir -p .toolbox/tools

    uniconf -c .toolbox.settings.yaml > .toolbox/.toolbox.settings.yaml

    yq r .toolbox/.toolbox.settings.yaml -j | jq -r '.tools | to_entries | .[] | @text "\(.value.source) \(.value.prefix)/\(.value.path)"' | xargs -n2 go-getter

    mkdir -p bin

    yq r .toolbox/.toolbox.settings.yaml -j | \
      jq -r '.tools | to_entries | .[] | .key' | \
      xargs -I "%" \
      sh -c "yq r .toolbox/.toolbox.settings.yaml -j | jq '.tools.%' | gomplate -f .toolbox/core/templates/bin/run.tpl -o bin/% --context task=stdin:///foo.yml; chmod a+x bin/%"

